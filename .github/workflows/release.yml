name: Release

on:
  push:
    branches:
      - main

jobs:
  release:
    permissions: write-all 
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        package_dir:
          - mount-helper-container

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
      
    - name: Run Unit Tests for cos csi mount helper container
      run: sudo make ut-coverage -C ${{ matrix.package_dir }}

    - name: Build Debian/rpm Packages for cos csi mount helper container
      run: |
          cd ${{ matrix.package_dir }}
          make packages
          
    - name: Latest Tag Release
      id: latest-tag
      uses: softprops/action-gh-release@v1
      with:
        files: |
          /home/runner/work/ibm-object-csi-driver/ibm-object-csi-driver/mount-helper-container/mount-helper-container-latest.tar.gz
          /home/runner/work/ibm-object-csi-driver/ibm-object-csi-driver/mount-helper-container/mount-helper-container-latest.tar.gz.sha256
        tag_name: latest
        name: Latest
        body: The latest release tag provides static link for package download. This has the same artificats as in the versioned latest version.

    - name: Latest Version
      id: release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          /home/runner/work/ibm-object-csi-driver/ibm-object-csi-driver/mount-helper-container/mount-helper-container-latest.tar.gz
          /home/runner/work/ibm-object-csi-driver/ibm-object-csi-driver/mount-helper-container/mount-helper-container-latest.tar.gz.sha256
        tag_name: 0.0.0
        name: 0.0.0
        body: CSR generated with SHA1 is not supported to get certs using Metadata.

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
